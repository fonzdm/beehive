apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: immich
    namespace: cloud
spec:
    interval: 1h0m0s
    chart:
        spec:
            chart: immich
            sourceRef:
                kind: HelmRepository
                name: immich
    postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              labelSelector: "app.kubernetes.io/name=server"
            patch: |-
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: icloudpd-volume
                  persistentVolumeClaim:
                    claimName: icloudpd-volume
              - op: add
                path: /spec/template/spec/containers/0/volumeMounts/-
                value:
                  name: icloudpd-volume
                  mountPath: /media/icloudpd
    values:
        controllers:
          main:
            containers:
              main:
                image:
                  tag: v2.1.0
                env:
                  DB_HOSTNAME: immich-db-cluster-rw
                  DB_USERNAME: immich
                  DB_DATABASE_NAME: immich
                  DB_PASSWORD: iMMich01 
                  IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
                  REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
        immich:
            metrics:
                enabled: false
            persistence:
                library:
                    existingClaim: cloud-storage
            configuration: {}
        valkey:
            enabled: true
        server:
            enabled: true 
            ingress:
                main:
                    enabled: true
                    className: nginx
                    annotations:
                        cert-manager.io/cluster-issuer: letsencrypt-cloudflare
                        kubernetes.io/ingress.class: nginx
                        nginx.ingress.kubernetes.io/proxy-body-size: "0"
                    hosts:
                        - host: photos.cloud.fonzdm.xyz
                          paths:
                            - path: /
                    tls:
                        - hosts:
                            - photos.cloud.fonzdm.xyz
                          secretName: immich-ing-external-secret
        machine-learning:
            enabled: true 
            persistence:
                cache:
                    enabled: true
                    size: 30Gi
                    type: persistentVolumeClaim
                    accessMode: ReadWriteMany
                    storageClass: nfs-client 
