apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: immich
    namespace: cloud
spec:
    interval: 1h0m0s
    chart:
        spec:
            chart: immich
            sourceRef:
                kind: HelmRepository
                name: immich
    postRenderers:
        - kustomize:
            patches:
                - target:
                    kind: Deployment
                    labelSelector: app.kubernetes.io/name=server
                  patch: |-
                    - op: add
                      path: /spec/template/spec/volumes/-
                      value:
                        name: icloudpd-volume
                        persistentVolumeClaim:
                          claimName: icloudpd-volume
                    - op: add
                      path: /spec/template/spec/containers/0/volumeMounts/-
                      value:
                        name: icloudpd-volume
                        mountPath: /media/icloudpd
    values:
        controllers:
            main:
                containers:
                    main:
                        image:
                            tag: v2.1.0
                        env:
                            DB_HOSTNAME: immich-db-cluster-rw
                            DB_USERNAME: immich
                            DB_DATABASE_NAME: immich
                            DB_PASSWORD: ENC[AES256_GCM,data:BDO3x3uv69OCX9DKLgiDZdKCP4M=,iv:brqQLnke7l8AEYg7pMwwWIuNUmeZTlbdEklN4DDp8+Q=,tag:LRjZ0gyPxpmCaovDtECHCg==,type:str]
                            IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
                            REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
        immich:
            metrics:
                enabled: false
            persistence:
                library:
                    existingClaim: cloud-storage
            configuration: {}
        valkey:
            enabled: true
        server:
            enabled: true
            ingress:
                main:
                    enabled: true
                    className: nginx
                    annotations:
                        cert-manager.io/cluster-issuer: letsencrypt-cloudflare
                        kubernetes.io/ingress.class: nginx
                        nginx.ingress.kubernetes.io/proxy-body-size: "0"
                    hosts:
                        - host: photos.cloud.fonzdm.xyz
                          paths:
                            - path: /
                    tls:
                        - hosts:
                            - photos.cloud.fonzdm.xyz
                          secretName: immich-ing-external-secret
        machine-learning:
            enabled: true
            persistence:
                cache:
                    enabled: true
                    size: 30Gi
                    type: persistentVolumeClaim
                    accessMode: ReadWriteMany
                    storageClass: nfs-client
sops:
    age:
        - recipient: age1fcyhrk0yse8cx49cq398z2uaewp3vxzqek5uph0usgsthzvspppqjp7dru
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA2a1QzN08zaHUwUDhUeFdQ
            VmNiRm01MzF6NWhyb1JNMmVyN1pQaTlnd2xnCmlSNmlLN1gzcExUc1BhaVJNTzBh
            a2ZuV1M3dGtTTzNtb2xZZlc1QjBGb1kKLS0tIFRCdjJCTnhmSkp6b0pSVUo5L1lr
            NThlR3hIZXd1QTUxNXUyVGEwbXJaWTAKtLnmctPZlaVXMH3X9qx1VT3x/cvigjRG
            ldySiwqEW+m/R5EWn5v6nd2zoZ/mhrxmI0uihKwNtBdr0FDJuwRbbQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-10-28T16:00:45Z"
    mac: ENC[AES256_GCM,data:mDhij900W3o08+NMq8/fp3VuiY4iommvgU1qqiJysVeCd/XR3hJkyYKPgpzDTDwj71w3a3IBNZPG8we4amJanGX+9wqgQLhlefLcyGmG9Ausr3xhIWkSMA9s1kI27IRvx9goNuYpzeYUmMuyeRKf8NOvqF6SEhFl+mVY/kBNU3Q=,iv:mu2w+Bh5BOi/WrmZn3zlGkZ/IrgLUB+PJfTHx+vx/EE=,tag:8GEu4OWgPiKLbrgunmFZmA==,type:str]
    encrypted_regex: ^(DB_PASSWORD)$
    version: 3.10.2
